
var WEBROOT = '';

var DEBUG_AJAX=false;

var URL_VEHICLES_GET_CURRENT_POSITIONS = WEBROOT + 'vehicles/get_current_positions.json'; 

var URL_LANDMARKS_GET_ENABLED = WEBROOT + 'taxis/landmarks/getEnabled.json'; 

var URL_SERVICES_GET_FORTHCOMING = WEBROOT + 'services/get_forthcoming.json'; 

var URL_USERS_GET_CLIENTS = WEBROOT + 'users/get_clients.json'; 
//var URL_USERS_UPDATE_DRIVER_STATUS = WEBROOT + 'users/update_driver_status'; 

/* Configure AJAX */
$.ajaxSetup({cache: false, 
             dataType: 'json', 
             error: function(jqXHR, textStatus, errorThrown) {
                 if(DEBUG_AJAX === true) {
                    console.log('AJAX error: ' + textStatus + ', ' + errorThrown);
                    console.log(jqXHR);
                 }
             }
            });

var monitor_ajax = {

    populateClientsList: function(select_node_name) {
        $.ajax(URL_USERS_GET_CLIENTS).done(
            function(data) {

                monitor_ajax.debugAJAXDone(URL_USERS_GET_CLIENTS, data, false);                                   

                for (indx in data) {
                    var client = data[indx];
                    var client_option = $('<option>').val(client.id)
                                                     .text(client.id)
                                                     .attr('name', client.name);

                    $( select_node_name ).append(client_option);
                }
            }
        );
    }, 

    /* Get the latest location reported by every taxi and update the map. */         
    updateTaxiLocationsOnMap: function (map) {                                         
        $.ajax(URL_VEHICLES_GET_CURRENT_POSITIONS).done(
            function(data) {                               

                monitor_ajax.debugAJAXDone(URL_VEHICLES_GET_CURRENT_POSITIONS, data, false);                                   
                                                                                 
                for (indx in data['taxisLatLon']) {                                      
                    object = data['taxisLatLon'][indx];                                  
                    taxiObject = object.Taxi;                                            
                    addTaxiMarkerToMap(map, taxiObject);                                 
                }                                                                        
            }
        );                                                                           
    },

    updateScheduledServicesList: function (container_selector) {
        $.ajax(URL_SERVICES_GET_FORTHCOMING).done(function(data) {

            monitor_ajax.debugAJAXDone(URL_SERVICES_GET_FORTHCOMING, data, false);

            var servicesControls = $(container_selector);
            for (indx in data['services']) {
                var address = data['services'][indx].Service.address;
                var scheduled = data['services'][indx].Service.scheduled;
                $('<div>').append(address + '<br/>' + scheduled) 
                          .css({
                              'background-color': 'white', 
                              'color': 'black', 
                              'border-radius': '3px', 
                              'margin': '2px 5px 2px 5px', 
                              'padding': '0 2px 0 2px', 
                              'cursor': 'pointer'})
                          .appendTo(servicesControls); 
            }
        })
    },

    
    /**
     * Add custom controls based on the Landmarks stored in the database.
     */
    addCustomControls: function (map) {
        $.ajax(URL_LANDMARKS_GET_ENABLED).done( function(data) {

            monitor_ajax.debugAJAXDone(URL_LANDMARKS_GET_ENABLED, data, false);

                for (indx in data['enabledLandmarks']) {
                    object = data['enabledLandmarks'][indx];
                    name = object.Landmark.name;
                    latitude = object.Landmark.latitude;
                    longitude = object.Landmark.longitude;

                    var geoLocation = new google.maps.LatLng(latitude, longitude);        
                    var locationControl = new monitor_controls.LocationControl(map, name, geoLocation);
                    map.controls[google.maps.ControlPosition.TOP_LEFT].push(locationControl);
                }                                                 
        });
    },

    debugAJAXDone: function (url, data, isEnabled) {
        if(isEnabled || DEBUG_AJAX === true) {
            console.log('AJAX done: ' + url);
            console.log(data);
        }
    }

}; /* monitor_ajax namespace */

/* EOF */ 
